<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis - Orbis Integration v9.1 (Direct + Fallback)</title>
    <style>
        /* Orbis Color Scheme */
        :root {
            --orbis-blue: #001489;
            --orbis-light-blue: #e6f4ff;
            --orbis-white: #ffffff;
            --orbis-gray: #f5f5f5;
            --orbis-text: #333333;
            --orbis-border: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--orbis-gray);
            color: var(--orbis-text);
            line-height: 1.6;
        }

        /* Orbis Header */
        .orbis-header {
            background: linear-gradient(135deg, var(--orbis-blue) 0%, #0033cc 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 20, 137, 0.3);
        }

        .orbis-header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .orbis-header .icon {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--orbis-blue);
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Company Info Card */
        .company-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--orbis-blue);
        }

        .company-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--orbis-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .company-details {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .company-id {
            background: var(--orbis-light-blue);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            color: var(--orbis-blue);
            display: inline-block;
        }

        /* Analysis Section */
        .analysis-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .analysis-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--orbis-light-blue);
        }

        .analysis-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--orbis-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Spinner */
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--orbis-light-blue);
            border-top: 4px solid var(--orbis-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: var(--orbis-blue);
            font-size: 16px;
            font-weight: 500;
        }

        /* AI Output */
        .ai-output {
            background: #f8f9fa;
            border: 1px solid var(--orbis-border);
            border-radius: 8px;
            padding: 20px;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .ai-output h3 {
            color: var(--orbis-blue);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .ai-output ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .ai-output li {
            margin-bottom: 8px;
        }

        /* Status Messages */
        .status-message {
            background: var(--orbis-light-blue);
            border: 1px solid var(--orbis-blue);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--orbis-blue);
            font-weight: 500;
        }

        .error-message {
            background: #ffe6e6;
            border: 1px solid #ff6b6b;
            color: #d63031;
        }

        .success-message {
            background: #e6ffe6;
            border: 1px solid #00b894;
            color: #00b894;
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .company-name {
                font-size: 24px;
            }
            
            .analysis-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Analysis Section -->
        <div class="analysis-section">

            <!-- Status Messages -->
            <div id="statusContainer"></div>

            <!-- Spinner -->
            <div id="spinnerContainer" class="spinner-container">
                <div class="spinner"></div>
                <div class="spinner-text" id="spinnerText">Initializing AI Analysis...</div>
            </div>

            <!-- AI Output -->
            <div id="aiOutput" class="ai-output hidden"></div>
        </div>
    </div>

    <script>
        // Configuration - Update these with your actual values
        const CONFIG = {
            API_CLIENT: '4e592a57-e663-4ab5-a298-55b0b3b808e7',
            API_KEY: '150fa4e6272a8ba660bbf49ee6a2baf7c280a11402ee46aa57be5a1b688cc80c',
            COPILOT_BASE_URL: 'https://api.moodys.com/copilot/v1',
            ASK_MY_DATA_URL: 'https://api.moodys.com/askmydata/v1/ask'
        };

        // Global variables
        let currentBvDID = null;
        let currentEntitlementId = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - v9.1 trying direct calls first, then CORS proxy fallback');
            // Extract BvD ID from URL parameters or set default for testing
            const urlParams = new URLSearchParams(window.location.search);
            currentBvDID = urlParams.get('BvDID') || 'US710415188'; // Default to Bureau van Dijk for testing
            
            startAnalysis();
        });

        // Update company information display
        function updateCompanyInfo() {
            // Company info elements were removed, so this function is no longer needed
            console.log('Company info update skipped - elements removed');
        }

        // Start the analysis process - TEST MOODY'S APIs ONLY
        async function startAnalysis() {
            try {
                console.log('üöÄ Starting AI analysis process...');
                updateStatus('Starting AI analysis process...', 'info');
                updateSpinner('Testing Moody APIs...');

                // TEST MODE: Skip PDF download, test Moody's APIs only
                console.log('üß™ TEST MODE: Testing Moody APIs (PDF download disabled due to timeout)...');
                updateStatus('TEST MODE: Testing Moody APIs (PDF timeout issue)...', 'info');

                // Step 1: Create entitlement (test Moody's API)
                console.log('üîë Step 1: Testing entitlement creation...');
                currentEntitlementId = await createEntitlement();
                console.log('‚úÖ Step 1: Entitlement created successfully:', currentEntitlementId);
                updateSpinner('Testing AI analysis...');

                // Step 2: Test AskMyData (without PDF)
                console.log('ü§ñ Step 2: Testing AskMyData API...');
                const analysis = await getAIAnalysis(currentEntitlementId);
                console.log('‚úÖ Step 2: AI analysis completed');
                
                // Step 3: Display results
                console.log('üìä Step 3: Displaying results...');
                displayResults(analysis);
                updateStatus('Moody APIs working! PDF download needs different approach.', 'success');
                console.log('üéâ Moody API test completed successfully!');

            } catch (error) {
                console.error('‚ùå Analysis failed:', error);
                updateStatus(`Analysis failed: ${error.message}`, 'error');
                updateSpinner('Analysis failed. Please try again.');
            }
        }

        // Download PDF from Orbis - BASIC VERSION
        async function downloadOrbisPDF() {
            // Use username and password authentication
            const username = 'smartURLArchitect';
            const password = 'SmartURL1234!';
            
            const pdfUrl = `https://orbis.bvdinfo.com/Orbis/companies/Report?BvDID=${currentBvDID}&export=pdf&user=${encodeURIComponent(username)}&pw=${encodeURIComponent(password)}`;
            
            console.log('üîç PDF Download Details:');
            console.log('  - BvD ID:', currentBvDID);
            console.log('  - Username:', username);
            console.log('  - Password:', password ? '***' + password.slice(-4) : 'NOT SET');
            console.log('  - PDF URL:', pdfUrl);
            
            try {
                console.log('üåê Making request to Orbis via custom proxy...');
                
            // Use a working CORS proxy for Orbis PDF
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(pdfUrl)}`;
            console.log('üîó Using CORS proxy:', proxyUrl);
            console.log('Target URL:', pdfUrl);
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/pdf',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                },
                // Add timeout for slow Orbis API
                signal: AbortSignal.timeout(180000) // 3 minute timeout
            });

                console.log('üì° Response received:');
                console.log('  - Status:', response.status);
                console.log('  - Status Text:', response.statusText);
                console.log('  - Headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    throw new Error(`Failed to download PDF: ${response.status} ${response.statusText}`);
                }

                console.log('üìÑ Converting response to blob...');
                const blob = await response.blob();
                console.log('‚úÖ PDF downloaded successfully:', blob.size, 'bytes');
                console.log('  - Blob type:', blob.type);
                return blob;
            } catch (error) {
                console.error('‚ùå PDF download error:', error);
                throw new Error(`PDF download failed: ${error.message}`);
            }
        }

        // Create entitlement
        async function createEntitlement() {
            console.log('üîë Creating entitlement (via serverless proxy):');
            console.log('  - API Client:', CONFIG.API_CLIENT);
            console.log('  - API Key:', CONFIG.API_CLIENT ? '***' + CONFIG.API_CLIENT.slice(-4) : 'NOT SET');
            console.log('  - Base URL:', CONFIG.COPILOT_BASE_URL);
            
            const entitlementData = {
                name: `Orbis Analysis - ${currentBvDID}`,
                description: `AI analysis of Orbis report for company ${currentBvDID}`
            };
            console.log('  - Entitlement Data:', entitlementData);

            // Try direct call first, then fallback to proxy
            console.log('üîó Trying direct API call first...');
            
            let response;
            try {
                // Try direct call first
                response = await fetch(`${CONFIG.COPILOT_BASE_URL}/entitlements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-client': CONFIG.API_CLIENT,
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(entitlementData)
                });
                console.log('‚úÖ Direct API call succeeded');
            } catch (error) {
                console.log('‚ùå Direct API call failed, trying CORS proxy...');
                // Fallback to CORS proxy
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(`${CONFIG.COPILOT_BASE_URL}/entitlements`)}`;
                response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-client': CONFIG.API_CLIENT,
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify(entitlementData)
                });
                console.log('‚úÖ CORS proxy call succeeded');
            }

            console.log('üì° Entitlement response:');
            console.log('  - Status:', response.status);
            console.log('  - Status Text:', response.statusText);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Entitlement creation failed:', errorText);
                throw new Error(`Failed to create entitlement: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('‚úÖ Entitlement created successfully:', result);
            return result.id;
        }

        // Upload to ingestion
        async function uploadToIngestion(blob, client, key, entitlementId, filename) {
            console.log('üì§ Uploading to ingestion (via CORS proxy):');
            const formData = new FormData();
            formData.append('file', blob, filename);
            formData.append('entitlement_id', entitlementId);

            // Try direct call first, then fallback to proxy
            console.log('üîó Trying direct upload call first...');
            
            let response;
            try {
                // Try direct call first
                response = await fetch(`${CONFIG.COPILOT_BASE_URL}/ingestion/upload`, {
                    method: 'POST',
                    headers: {
                        'x-api-client': client,
                        'x-api-key': key
                    },
                    body: formData
                });
                console.log('‚úÖ Direct upload call succeeded');
            } catch (error) {
                console.log('‚ùå Direct upload call failed, trying CORS proxy...');
                // Fallback to CORS proxy
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(`${CONFIG.COPILOT_BASE_URL}/ingestion/upload`)}`;
                response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'x-api-client': client,
                        'x-api-key': key
                    },
                    body: formData
                });
                console.log('‚úÖ CORS proxy upload call succeeded');
            }

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.status}`);
            }

            const result = await response.json();
            console.log('Upload successful:', result.document_id);
            return result.document_id;
        }

        // Get AI analysis
        async function getAIAnalysis(entitlementId) {
            const systemPrompt = `You are a senior financial analyst at Moody's. Analyze the provided Orbis company report and provide a comprehensive analysis covering:

1. COMPANY OVERVIEW:
   - Business model and key operations
   - Market position and competitive advantages
   - Recent developments and strategic initiatives

2. FINANCIAL ANALYSIS:
   - Key financial metrics and trends
   - Revenue, profitability, and growth patterns
   - Financial strength and risk indicators

3. RISK ASSESSMENT:
   - Credit risk factors
   - Market and operational risks
   - Regulatory and compliance considerations

4. INVESTMENT OUTLOOK:
   - Growth prospects and opportunities
   - Key challenges and headwinds
   - Overall investment recommendation

Provide evidence-based insights with specific data points from the report.`;

            // Try direct call first, then fallback to proxy
            console.log('üîó Trying direct AskMyData call first...');
            
            let response;
            try {
                // Try direct call first
                response = await fetch(CONFIG.ASK_MY_DATA_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-client': CONFIG.API_CLIENT,
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        source: { name: 'orbis-integration', version: '1.0.0' },
                        stream: false,
                        system_prompt: systemPrompt,
                        messages: [{
                            role: 'user',
                            content: 'Please analyze the provided Orbis company report and provide a comprehensive financial and risk analysis.'
                        }],
                        entitlement_ids: [entitlementId]
                    })
                });
                console.log('‚úÖ Direct AskMyData call succeeded');
            } catch (error) {
                console.log('‚ùå Direct AskMyData call failed, trying CORS proxy...');
                // Fallback to CORS proxy
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(CONFIG.ASK_MY_DATA_URL)}`;
                response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-client': CONFIG.API_CLIENT,
                        'x-api-key': CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        source: { name: 'orbis-integration', version: '1.0.0' },
                        stream: false,
                        system_prompt: systemPrompt,
                        messages: [{
                            role: 'user',
                            content: 'Please analyze the provided Orbis company report and provide a comprehensive financial and risk analysis.'
                        }],
                        entitlement_ids: [entitlementId]
                    })
                });
                console.log('‚úÖ CORS proxy AskMyData call succeeded');
            }

            if (!response.ok) {
                throw new Error(`AI analysis failed: ${response.status}`);
            }

            const result = await response.json();
            return result.response?.content || result.data?.[0]?.response?.content || 'Analysis completed but no content returned.';
        }

        // Update status message
        function updateStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type === 'error' ? 'error-message' : type === 'success' ? 'success-message' : ''}`;
            statusDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(statusDiv);
        }

        // Update spinner text
        function updateSpinner(text) {
            document.getElementById('spinnerText').textContent = text;
        }

        // Display results
        function displayResults(analysis) {
            document.getElementById('spinnerContainer').classList.add('hidden');
            document.getElementById('aiOutput').classList.remove('hidden');
            document.getElementById('aiOutput').textContent = analysis;
        }
    </script>
</body>
</html>
